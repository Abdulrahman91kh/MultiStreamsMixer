<!--
> Muaz Khan     - www.MuazKhan.com
> MIT License   - www.WebRTC-Experiment.com/licence
> Documentation - github.com/muaz-khan/MultiStreamsMixer
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <title>MultiStreamsMixer | Mix Multiple Cameras & Screens into Single Stream</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="author" type="text/html" href="https://plus.google.com/+MuazKhan">
    <meta name="author" content="Muaz Khan">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <link rel="stylesheet" href="https://cdn.webrtc-experiment.com/style.css">

    <style>
        h1 span {
            background: yellow;
            border: 2px solid #8e1515;
            padding: 2px 8px;
            margin: 2px 5px;
            border-radius: 7px;
            color: #8e1515;
            display: inline-block;
        }

        video {
            max-width: 100%;
        }
    </style>

    <script src="https://cdn.webrtc-experiment.com/MultiStreamsMixer.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://cdn.webrtc-experiment.com/getScreenId.js"> </script>

    <script src="https://cdn.webrtc-experiment.com/syntax/sh_main.min.js" type="text/javascript"> </script>
    <script src="https://cdn.webrtc-experiment.com/syntax/sh_javascript.min.js" type="text/javascript"> </script>
    <script src="https://cdn.webrtc-experiment.com/syntax/sh_html.min.js" type="text/javascript"> </script>
    <link href="https://cdn.webrtc-experiment.com/syntax/sh_style.css" type="text/css" rel="stylesheet">
</head>

<body onload="sh_highlightDocument();">
    <article>
        <header style="text-align: center;">
            <h1>
                MultiStreamsMixer | Mix Multiple Cameras & <br>Screens into Single Stream
            </h1>
            <p style="margin:0;">
                <a href="https://www.webrtc-experiment.com/">HOME</a>
                <span> &copy; </span>
                <a href="http://www.MuazKhan.com/" target="_blank">Muaz Khan</a> .
                <a href="http://twitter.com/WebRTCWeb" target="_blank" title="Twitter profile for WebRTC Experiments">@WebRTCWeb</a> .
                <a href="https://github.com/muaz-khan?tab=repositories" target="_blank" title="Github Profile">Github</a> .
                <a href="https://github.com/muaz-khan/MultiStreamsMixer/issues?state=open" target="_blank">Latest issues</a> .
                <a href="https://github.com/muaz-khan/MultiStreamsMixer/commits/master" target="_blank">What's New?</a>
            </p>
        </header>

        <div class="github-stargazers"></div>

        <blockquote>
            Pass multiple streams (e.g. screen+camera or multiple-cameras) and get single stream.

            <br><br>Requires <a href="https://chrome.google.com/webstore/detail/screen-capturing/ajhifddimkapgcifgcodmmfdlknahffk" target="_blank">THIS CHROME EXTENSION</a> and following Chrome flag:

            <pre class="sh_javascript">
chrome://flags/#enable-experimental-web-platform-features
</pre>
        </blockquote>

        <section class="experiment" style="text-align: center;">
            <button>Get Mixed Camera+Screen Stream</button>
            <video muted autoplay></video>
        </section>

        <script>
            var video = document.querySelector('video');
            document.querySelector('button').onclick = function() {
                this.disabled = true;

                getScreenId(function (error, sourceId, screen_constraints) {
                    navigator.mediaDevices.getUserMedia(screen_constraints).then(function(screenStream) {
                        var cameraHints = { audio: true, video: true, aspectRatio: 1.77 };
                        navigator.mediaDevices.getUserMedia(cameraHints).then(function(cameraStream) {
                            screenStream.fullcanvas = true;
                            screenStream.width = screen.width; // or 3840
                            screenStream.height = screen.height; // or 2160 

                            cameraStream.width = parseInt((20 / 100) * screenStream.width);
                            cameraStream.height = parseInt((20 / 100) * screenStream.height);
                            cameraStream.top = screenStream.height - cameraStream.height;
                            cameraStream.left = screenStream.width - cameraStream.width;

                            var mixer = new MultiStreamsMixer([screenStream, cameraStream]);

                            mixer.setOptions({
                                frameInterval: 1
                            });

                            mixer.startDrawingFrames();

                            video.srcObject = mixer.mixedStream;

                            addStreamStopListener(screenStream, function() {
                                mixer.releaseStreams();
                                video.pause();
                                video.src = null;

                                cameraStream.getTracks().forEach(function(track) {
                                    track.stop();
                                });
                            });
                        });
                    });
                });
            };

            function addStreamStopListener(stream, callback) {
                var streamEndedEvent = 'ended';
                if ('oninactive' in stream) {
                    streamEndedEvent = 'inactive';
                }
                stream.addEventListener(streamEndedEvent, function() {
                    callback();
                    callback = function() {};
                }, false);
                stream.getAudioTracks().forEach(function(track) {
                    track.addEventListener(streamEndedEvent, function() {
                        callback();
                        callback = function() {};
                    }, false);
                });
                stream.getVideoTracks().forEach(function(track) {
                    track.addEventListener(streamEndedEvent, function() {
                        callback();
                        callback = function() {};
                    }, false);
                });
            }
        </script>

        <section class="experiment">
            <h2>How to use MultiStreamsMixer?</h2>
            <pre class="sh_javascript">
// https://cdn.webrtc-experiment.com/MultiStreamsMixer.js
screenStream.fullcanvas = true;
screenStream.width = screen.width; // or 3840
screenStream.height = screen.height; // or 2160 

cameraStream.width = parseInt((20 / 100) * screenStream.width);
cameraStream.height = parseInt((20 / 100) * screenStream.height);
cameraStream.top = screenStream.height - cameraStream.height;
cameraStream.left = screenStream.width - cameraStream.width;

var mixer = new MultiStreamsMixer([screenStream, cameraStream]);

mixer.mixedStream.getTracks().forEach(function(track) {
    rtcPeerConnection.addTrack(track, mixer.mixedStream)
});

mixer.setOptions({
    frameInterval: 1
});

mixer.startDrawingFrames();

btnStopStreams.onclick = function() {
    mixer.releaseStreams();
};

btnAppendNewStreams.onclick = function() {
    mixer.appendStreams([anotherStream]);
};

btnStopScreenSharing.onclick = function() {
    // replace all old streams with this one
    // it will replace only video tracks
    mixer.replaceStreams([cameraStreamOnly]);
};
</pre>
        </section>

        <section class="experiment own-widgets">
            <h2 class="header" id="updates" style="color: red; padding-bottom: .1em;"><a href="https://github.com/muaz-khan/MultiStreamsMixer/issues" target="_blank">Issues</a>
            </h2>
            <div id="github-issues"></div>
        </section>

        <section class="experiment"><small id="send-message"></small></section>

        <section class="experiment own-widgets latest-commits">
            <h2 class="header" id="updates" style="color: red; padding-bottom: .1em;"><a href="https://github.com/muaz-khan/MultiStreamsMixer/commits/master" target="_blank">Latest Updates</a>
            </h2>
            <div id="github-commits"></div>
        </section>
    </article>

    <a href="https://github.com/muaz-khan/MultiStreamsMixer" class="fork-left"></a>

    <footer>
        <p>
            <a href="https://www.webrtc-experiment.com/">WebRTC Experiments</a> Â© <a href="https://plus.google.com/+MuazKhan" rel="author" target="_blank">Muaz Khan</a>
            <a href="mailto:muazkh@gmail.com" target="_blank">muazkh@gmail.com</a>
        </p>
    </footer>

    <!-- commits.js is useless for you! -->
    <script>
        window.useThisGithubPath = 'muaz-khan/MultiStreamsMixer';
    </script>
    <script src="https://cdn.webrtc-experiment.com/commits.js" async></script>
</body>

</html>
